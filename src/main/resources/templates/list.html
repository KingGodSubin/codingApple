<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <!-- ê²½ë¡œë¥¼ / ë¶€í„° ì‹œì‘í•˜ë©´ static í´ë” íŒŒì¼ë“¤ ì‚¬ìš© ê°€ëŠ¥ -->
    <link href="/main.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<!-- ë³„ë„ì˜ íŒŒì¼ì— ì €ì¥í•´ë‘ê³  í•œ ì¤„ë¡œ import í•´ì„œ ì‚¬ìš©ê°€ëŠ¥(th : fragment ë¬¸ë²•) -->
<!--<div class="nav">-->
<!--    <a class="logo">SpringMall</a>-->
<!--    <a>List</a>-->
<!--    <a>Write</a>-->
<!--</div>-->
<div th:replace="~{ nav.html::navbar }"></div>

<form id="searchForm">
    <input name="searchText" style="display : inline">
    <button id="searchBtn">ê²€ìƒ‰</button>
</form>
<!--  th: thymeleaf ì•½ì  -->
<!-- th:each html ì‰½ê²Œ ë³µë¶™ê°€ëŠ¥(ë°˜ë³µë¬¸) -->
<div id="replace">
    <div class="card" th:each="item : ${items}">
        <img th:src="${item.itemFilePath}">
        <div>
            <h4 th:text="${item.title}">ë°”ì§€</h4>
            <a th:href="@{'/detail/' + ${item.id}}">ë§í¬</a>
            <p th:text="${item.price} + ì›">7ì–µ</p>
            <a th:href="@{/edit/{itemId}(itemId=${item.id})}">âœï¸</a>
            <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ì— Thymeleaf ë³€ìˆ˜ ë„£ìœ¼ë ¤ë©´ -->
            <!-- .then() ë¶™ì´ë©´ AJAX ìš”ì²­ ì™„ë£Œì‹œ ì½”ë“œì‹¤í–‰ê°€ëŠ¥  -->
            <!--        <span th:onclick="fetch('/item?itemId=[[${item.id}]]', {method : 'DELETE'})-->
            <!--            .then(r => r.text())-->
            <!--            .then(() => {-->
            <!--                location.reload();-->
            <!--            })-->
            <!--        ">ğŸ—‘ï¸</span>-->
            <button class="deleteItem" th:data-item-id="${item.id}">ğŸ—‘ï¸</button>
        </div>
    </div>
</div>
<div th:if="${totalPages != 0}">
    <div class="pagination" th:each="page : ${#numbers.sequence(1, totalPages)}">
        <button class="eachPage" th:text="${page}" th:data-page-idx="${page}"></button>
    </div>
</div>

<script>

    // document.querySelectorAll('.btn')[0].addEventListener("click", function () {
    //     fetch('/test1', {  // ì—¬ê¸° urlë¡œ
    //         method : 'post', // POST ìš”ì²­ì´ ë‚ ë¼ê°€ëŠ”ë°
    //         headers : { 'Content-Type' : 'application/json' }, // json ë°ì´í„°ë¥¼ ë³´ë‚´ê² ë‹¤
    //         body : JSON.stringify({name : 'kim'}) // ì´ ë°ì´í„°ë¥¼ ë“¤ê³  ë‚ ë¼ê°
    //         // stringify ë¬¸ìë¡œ ë³€í™˜í•´ì£¼ëŠ” í•¨ìˆ˜
    //     })
    // })

    // ì´ˆê¸°í™” ì‹œ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    $(document).ready(function () {
        bindDeleteButton();
        bindPaginationButton();
        search();
    });

    // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ
    function bindDeleteButton() {
        $('.deleteItem').each(function () {
            var itemId = $(this).data("item-id");
            var thisParents = $(this).closest(".card");
            $(this).click(function () {
                console.log(itemId + "í´ë¦­");
                $.ajax({
                    // /deleteë¡œ ê°€ë¼
                    url: "/delete",
                    // methodëŠ” GET ë°©ì‹(query string)
                    method: "GET",
                    // dataëŠ” itemidë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë“¤ê³  ê°€ë¼
                    data: {itemId: itemId},
                    // ì„±ê³µí–ˆì„ë•?
                    success: function () {
                        thisParents.remove();
                    },
                    // ì‹¤íŒ¨í–ˆì„ë•?
                    fail: function () {
                        console.log("ì‹¤íŒ¨");
                    }
                })
            });
        });
    }

    // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    function bindPaginationButton() {
        $(".eachPage").each(function () {
            var searchText = $('input[name="searchText"]').val();
            var pageIdx = $(this).data("page-idx");
            $(this).click(function () {
                $.ajax({
                    url: "/list",
                    method: "GET",
                    data: {pageIdx: pageIdx, searchText: searchText},
                    success: function (data) {
                        var data = $.parseHTML(data);
                        var dataHtml = $("<div>").append(data);
                        $("#replace").replaceWith(dataHtml.find("#replace"));
                        // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì¬ë°”ì¸ë”©
                        bindDeleteButton();
                        bindPaginationButton();
                    }
                })
            })
        });
    }

    function search() {
        $("#searchBtn").click(function (e) {
            e.preventDefault();
            var searchText = $('input[name="searchText"]').val();
            $.ajax({
                url: "/list",
                method: "GET",
                data: {searchText: searchText},
                success: function (data) {
                    var data = $.parseHTML(data);
                    var dataHtml = $("<div>").append(data);
                    $("#replace").replaceWith(dataHtml.find("#replace"));
                    // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì¬ë°”ì¸ë”©
                    bindDeleteButton();
                    bindPaginationButton();
                }
            })
        })
    }
</script>
</body>
</html>